{
	"nodes":[
		{"id":"17fe254da4ca9376","type":"group","x":5120,"y":880,"width":1000,"height":1480,"label":"Objects"},
		{"id":"78789d223147b039","type":"link","url":"https://superuser.com/questions/471769/what-is-the-nt-authority-system-user","x":-1880,"y":2284,"width":1504,"height":799},
		{"id":"a24f19bddc75e203","type":"link","url":"https://superuser.com/questions/1067246/is-nt-authority-system-a-user-or-a-group","x":-1880,"y":3164,"width":1504,"height":840},
		{"id":"ba2818c684aabf29","type":"link","url":"https://youtu.be/zrCNGzwLjcU","x":-2238,"y":40,"width":640,"height":360},
		{"id":"ffe2da14697b4725","type":"link","url":"https://www.hackingarticles.in/active-directory-enumeration-rpcclient/","x":-1880,"y":1444,"width":1172,"height":740},
		{"id":"c276bc3b612152b4","type":"link","url":"https://wadcoms.github.io/#","x":-3120,"y":1444,"width":1120,"height":740},
		{"id":"44de365dd50e02e4","type":"link","url":"https://www.netexec.wiki/","x":-3120,"y":2284,"width":1120,"height":721},
		{"id":"1a066ee23b20fbaa","type":"text","text":"# PKI\n\n## the use of _Public Key Infrastructure_ (PKI)[12](https://portal.offsec.com/courses/PEN-200-44065/learning/attacking-active-directory-authentication-46102/understanding-active-directory-authentication-46171/cached-ad-credentials-46105#fn-local_id_42-12) in AD.\nMicrosoft provides the AD role _Active Directory Certificate Services_ (AD CS)[13](https://docs.microsoft.com/en-us/training/modules/implement-manage-active-directory-certificate-services/) to implement a PKI, which exchanges digital certificates between authenticated users and trusted resources.\n\nIf a server is installed as a _Certification Authority_ (CA),[14](https://en.wikipedia.org/wiki/Certificate_authority) it can issue and revoke digital certificates (and much more). While a deep discussion on these concepts would require its own Module, let's focus on one aspect of cached and stored objects related to AD CS.\n\nFor example, we could issue certificates for web servers to use HTTPS or to authenticate users based on certificates from the CA via _Smart Cards_.[15](https://en.wikipedia.org/wiki/Smart_card)\n\nThese certificates may be marked as having a _non-exportable private key_[16](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/marking-private-keys-as-non-exportable-with-certutil-importpfx/ba-p/1128390) for security reasons. If so, a private key associated with a certificate cannot be exported even with administrative privileges. However, there are various methods to export the certificate with the private key.\n\nWe can rely again on Mimikatz to accomplish this. The _crypto_[17](https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto) module contains the capability to either patch the _CryptoAPI_[18](https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptoapi-system-architecture) function with **crypto::capi**[19](https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#capi) or _KeyIso_[20](http://revertservice.com/10/keyiso/) service with **crypto::cng**,[21](https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#cng) making non-exportable keys exportable.","x":4845,"y":-3680,"width":1275,"height":494},
		{"id":"ae0f25725cf455c1","type":"text","text":"# Kerberos\nUsed by any recent version of Windows. This is the default protocol in any recent domain.","x":6334,"y":-3186,"width":414,"height":146},
		{"id":"d33ea6d684654efc","type":"text","text":"# Authentication\nauthenticate to a service using domain credentials,","x":5520,"y":-2586,"width":540,"height":106},
		{"id":"87e264f588b3e6a8","type":"file","file":"NOTES/98. Theory/Kerberos.md","x":6880,"y":-3633,"width":1420,"height":1040},
		{"id":"17acf80b3b887a4d","type":"text","text":"# NTLM\nLegacy authentication protocol kept for compatibility purposes.","x":6378,"y":-2070,"width":326,"height":128},
		{"id":"ad0bff2805a09f6f","type":"text","text":"# Group Policy Management tool\nTool to configure GPOs\n![[Pasted image 20240506144531.png]]\n![[Pasted image 20240506145510.png]]\n","x":6240,"y":-260,"width":993,"height":805},
		{"id":"f25c28af3b7378d9","type":"text","text":"# Example\n## Restrict Access to Control Panel\n1. Create a new GPO called `Restrict Control Panel Access`\n\t![[Pasted image 20240507102449.png]]\n1. Link it to all of the OUs corresponding to users who shouldn't have access to the Control Panel of their PCs.\n\t![[Pasted image 20240507102820.png]]\n","x":7440,"y":-362,"width":899,"height":997},
		{"id":"8e72b12003f267e7","type":"text","text":"# zmiana polityk (uprawnień) dla urządzeń/użytkowników ze względu na funkcję","x":7440,"y":-1136,"width":600,"height":163,"color":"5"},
		{"id":"2331d19d36fd4afe","type":"file","file":"NOTES/98. Theory/LM_NTLM_NTLMv2.md","x":6880,"y":-2480,"width":1420,"height":947},
		{"id":"05abdd156b6c6f6b","type":"link","url":"https://youtu.be/LOG-ewxwCOU","x":-1520,"y":480,"width":640,"height":360},
		{"id":"1e6f5a52c3e4f158","type":"text","text":"# Local Security Authority Subsystem Service (LSASS)\n[[1]](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service#cite_note-1) is a [process](https://en.wikipedia.org/wiki/Process_(computing) \"Process (computing)\") in [Microsoft Windows](https://en.wikipedia.org/wiki/Microsoft_Windows \"Microsoft Windows\") [operating systems](https://en.wikipedia.org/wiki/Operating_system \"Operating system\") that is responsible for enforcing the [security policy](https://en.wikipedia.org/wiki/Security_policy \"Security policy\") on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates [access tokens](https://en.wikipedia.org/wiki/Access_token \"Access token\").[[2]](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service#cite_note-2) It also writes to the [Windows Security Log](https://en.wikipedia.org/wiki/Windows_Security_Log \"Windows Security Log\").\n","x":3597,"y":-2701,"width":1248,"height":461},
		{"id":"f5f3838382294714","type":"file","file":"NOTES/2. Windows/AD/1. Learn AD.md","x":639,"y":-4198,"width":861,"height":698},
		{"id":"5115c74cbe8ef872","type":"link","url":"https://github.com/AfvanMoopen/tryhackme-/tree/master/Active%20Directory%20Basics","x":-200,"y":1444,"width":1169,"height":574},
		{"id":"fbc958a159b20a21","type":"text","text":"# Trees\n- **Trees in Active Directory**: Active Directory allows integration of multiple domains for network partitioning and independent management.\n- **Tree Structure**: Domains sharing the same namespace can be organized into a tree structure. For instance, domains like `uk.thm.local` and `us.thm.local` can be subdomains of `thm.local`.\n```mermaid \ngraph TB\n\tthm.local[ROOT DOMAIN<br>thm.local]\n\tthm.local --> uk.thm.local\n\tthm.local --> us.thm.local\n```\n- **Benefits**: Partitioned structure enhances control over resource access. Each branch has its own domain controller (DC) for managing resources independently.\n- **Control**: Domain Administrators of each branch have control over their respective DCs, ensuring segregation of administrative tasks.\n- **Policies**: Policies can be configured independently for each domain in the tree, facilitating tailored management.\n\n","x":4085,"y":-1461,"width":633,"height":620},
		{"id":"5f0a4c818bd75a77","type":"text","text":"# AD levels\n```mermaid\ngraph TD\n\tsubgraph Forest\n\ttree1\n\ttree2\n\tend\n\n\tsubgraph tree2[TREE 2]\n\t\txyz.local[xyz.local<br>ROOT DOMAIN] -->sub1.xyz.local[sub1.xyz.local<br>SUBDOMAIN 1]\n\t\txyz.local -->sub2.xyz.local[sub2.xyz.local<br>SUBDOMAIN 2]\t\n\tend\n\t\n\tsubgraph tree1[TREE 1]\n\t\tabc.local[abc.local<br>ROOT DOMAIN] -->sub1.abc.local[sub1.abc.local<br>SUBDOMAIN 1]\n\t\tabc.local -->sub2.abc.local[sub2.abc.local<br>SUBDOMAIN 2]\t\n\tend\n\t\n\tsub1.abc.local --> OUs\n\tsub1.abc.local --> Policies --> Group_Policy_Management_tool[Group Policy Management tool]\n\tsub1.abc.local --> Security_Groups[Security Groups]\n\n\tsubgraph OUs[Organizational Units]\n\t\tUsers\n\t\tMachines\n\tend\n\tOUs --> Active_Directory_Users_and_Computers_tool[Active Directory Users and Computers tool]\n\t\n\tsubgraph Default_Security_Groups[Default Security Groups]\n\tdirection LR\n\t\tsubgraph _1[ ]\n\t\tEnterprise_Admins[Enterprise Admins]\n\t\tDomain_Admins[Domain Admins]\n\t\tServer_Operators[Server Operators]\n\t\tend\n\t\tsubgraph _2[ ]\n\t\tBackup_Operators[Backup Operators]\n\t\tAccount_Operators[Account Operators]\n\t\tDomain_Users[Domain Users]\n\t\tend\n\t\tsubgraph _3[ ]\n\t\tDomain_Computers[Domain Computers]\n\t\tDomain_Controllers[Domain Controllers]\n\t\tend\n\tend\n\tSecurity_Groups ---> Default_Security_Groups\n```","x":3746,"y":40,"width":1273,"height":1245},
		{"id":"6cc953ebda25e576","type":"text","text":"# Active Diretory\nUse to provides authentication, group and user management\nDirectory Service Database","x":4016,"y":-611,"width":496,"height":162},
		{"id":"b615830acf9346fa","type":"text","text":"# Forests\n- Domains can be configured in different namespaces.\n- Example: Suppose your company acquires another company.\n- After merging, each company might have its own domain tree managed by separate IT departments.\n- The combination of these different domain trees into one network is called a **forest**.","x":3186,"y":-1461,"width":830,"height":209},
		{"id":"1028fc6521e4bb7d","type":"text","text":"# Trust relationship\n- Organizing domains into trees and forests helps in managing and allocating resources efficiently.\n- Trust relationships connect domains within trees and forests, enabling users to access resources across different domains.\n- One-way trust relationships authorize users from one domain to access resources in another domain.\n- Two-way trust relationships allow mutual authorization between domains, enabling users from both domains to access each other's resources.\n- Establishing a trust relationship doesn't automatically grant access to all resources; authorization still needs to be configured based on specific requirements.","x":3705,"y":-1936,"width":760,"height":420},
		{"id":"289d04377b6b5891","type":"text","text":"# Machines:\n- Created for every computer joining the domain.\n- Also considered security principals, with limited rights within the domain.\n- Identified by a specific naming scheme, like \"computername$\".","x":5186,"y":1146,"width":813,"height":175},
		{"id":"62ea680e14602b42","type":"text","text":"# Security Groups:\n- Used to assign access rights to files or resources to groups of users or machines.\n- Also considered security principals, capable of having privileges over network resources.\n- Default groups like Domain Admins, Server Operators, etc., grant specific privileges to users.\n","x":5186,"y":1373,"width":813,"height":175},
		{"id":"855e908ce3c2d467","type":"text","text":"# Default Security Groups\n|Security Group|\tDescription|\n|:-:|-|\n|Domain Admins|\tUsers of this group have administrative privileges over the entire domain. By default, they can administer any computer on the domain, including the DCs.|\n|Server Operators|\tUsers in this group can administer Domain Controllers. They cannot change any administrative group memberships.|\n|Backup Operators|\tUsers in this group are allowed to access any file, ignoring their permissions. They are used to perform backups of data on computers.|\n|Account Operators|\tUsers in this group can create or modify other accounts in the domain.|\n|Domain Users|\tIncludes all existing user accounts in the domain.|\n|Domain Computers|\tIncludes all existing computers in the domain.|\n|Domain Controllers|\tIncludes all existing DCs on the domain.|","x":5226,"y":1548,"width":773,"height":503},
		{"id":"5d94481632dbe5cd","type":"text","text":"**Enterprise Admins**\n- introduced when talking about trees and forests\n- grant a user administrative privileges over all of an enterprise's domains.","x":5579,"y":2120,"width":420,"height":200},
		{"id":"c4e3f7fbbd8a29e0","type":"text","text":"# Users\n- Commonly represent individuals or services within the organization.\n- Known as security principals, they can be authenticated and assigned privileges over network resources.","x":5186,"y":931,"width":813,"height":175},
		{"id":"5636a9ac9efe26aa","type":"text","text":"credentials are stored in the Domain Controllers.","x":4497,"y":-140,"width":441,"height":63},
		{"id":"bc1251774e8bc568","type":"text","text":"# Domain Controller (DC)\nThe server that runs the Active Directory services","x":4504,"y":-280,"width":428,"height":104},
		{"id":"36a3f7e7f282ba71","type":"text","text":"# Windows Domains\n- **Centralised identity management:** All users across the network can be configured from Active Directory with minimum effort.\n- **Managing security policies:** You can configure security policies directly from Active Directory and apply them to users and computers across the network as needed.","x":4718,"y":-640,"width":602,"height":219,"color":"1"},
		{"id":"f2c59834637a3c07","type":"text","text":"The main idea behind a domain is to centralise the administration of common components of a Windows computer network in a single repository called **Active Directory (AD)**.","x":4967,"y":-140,"width":520,"height":120},
		{"id":"2b4762e8b5ef7630","type":"text","text":"is a group of users and computers under the administration of a given business.","x":5037,"y":-280,"width":380,"height":67},
		{"id":"b6475ff67cd1879c","type":"text","text":"# Organizational Units (OUs)\nobjects are organised in Organizational Units (OUs) which are container objects that allow you to classify users and machines","x":6446,"y":1043,"width":582,"height":191},
		{"id":"d1d0dcd6e6cdd968","type":"text","text":"# Security Groups vs Organizational Units (OUs)\nSecurity Groups and OUs serve distinct purposes in organizing users and computers within a Windows Domain:\n\n- **OUs (Organizational Units)**: Used for applying policies and configurations based on user roles within the enterprise. A user can belong to only one OU at a time, ensuring policies aren't conflicting.\n    \n- **Security Groups**: Employed to grant permissions over resources like shared folders or network printers. Users can belong to multiple groups to access various resources effectively.","x":6337,"y":1308,"width":800,"height":305},
		{"id":"32f940947905d88b","type":"text","text":"# Reset a password using PS in AD after delegation of \nWhen You delegate privilege to specific user he can open **Active Directory Users and Computers** tool, then use PS\n```powershell\nPS> Set-ADAccountPassword sophie -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose # reset sophis password and set new\nPS> Set-ADUser -ChangePasswordAtLogon $true -Identity sophie -Verbose # force a password reset at the next logon\n```","x":6195,"y":2148,"width":1084,"height":292},
		{"id":"58d347cea7ed541c","type":"text","text":"# containers (OUs) created automatically\n- **Builtin:** Contains default groups available to any Windows host.\n- **Computers:** Any machine joining the network will be put here by default. You can move them if needed.\n- **Domain Controllers:** Default OU that contains the DCs in your network.\n- **Users:** Default users and groups that apply to a domain-wide context.\n- **Managed Service Accounts:** Holds accounts used by services in your Windows domain.","x":7563,"y":1020,"width":852,"height":253},
		{"id":"537d3c32bfc4306c","type":"text","text":"# Active Directory Users and Computers tool\n1. log in to the Domain Controller > run \"Active Directory Users and Computers\" from the start menu\n![[Pasted image 20240506131335.png]]\n1. See the hierarchy of users, computers and groups that exist in the domain\n2. objects are organised in **Organizational Units (OUs)**\n## Managing Users in AD\n1. Deleting extra OUs and users\n\t1. By default, OUs are protected against accidental deletion.\n\t2. To delete the OU, we need to enable the **Advanced Features** in the View menu.\n2. **Delegation** (give specific users some control over some OUs)\n## Managing Computers in AD\nBy default, all the machines that join a domain (except for the DCs) will be put in the container called \"Computers\".\nHaving all of our devices there is not the best idea since it's very likely that you want different policies for your servers and the machines that regular users use on a daily basis.\nBasic 3 categories:\n1. Workstations\n2. Servers\n3. Domain Controllers","x":7324,"y":1548,"width":1220,"height":817},
		{"id":"ad72a852e84a2228","type":"text","text":"# Organizacja ze względu na funkcję","x":6948,"y":829,"width":568,"height":102,"color":"4"},
		{"id":"fea9185fb7022f08","type":"text","text":"# policies","x":6240,"y":-871,"width":250,"height":60},
		{"id":"59883ad7483ff198","type":"text","text":"# Group Policy Objects (GPO)\nBackground: Users and computers organized in different Organizational Units (OUs) to be able to push different configurations and security baselines to users depending on their department.\n\n- Windows manages policies through **Group Policy Objects (GPO)**.\n- GPO - Collection of settings that can be applied to OUs.\n- GPOs can contain policies aimed at either users or computers, allowing to set a baseline on specific machines and identities.\n- Any GPO will apply to the linked OU and any sub-OUs under it.\n- By default **Security Filtering** (in settings of GPO) will apply to the Authenticated Users group, which includes all users/PCs.\n- Can apply Security Filtering to GPOs so that they are only applied to specific users/computers under an OU.","x":6240,"y":-720,"width":992,"height":332},
		{"id":"5658a4d0f0bac8dd","type":"text","text":"# GPO distribution\n- GPOs are distributed to the network via a network share called `SYSVOL`, which is stored in the DC.\n- It's a folder on all domain controllers storing Group Policy Objects (GPOs) and domain-related scripts.\n- All users in a domain should typically have access to this share over the network to sync their GPOs periodically.\n- The `SYSVOL` share points by default to the `C:\\Windows\\SYSVOL\\sysvol\\` directory on each of the DCs in our network.\n- Once a change has been made to any GPOs, it might take up to 2 hours for computers to catch up.\n- force any particular computer to sync its GPOs immediately\n\t```powershell\n\tPS> gpupdate /force\n\t```\n","x":7463,"y":-745,"width":829,"height":383},
		{"id":"d622ceebe111ca41","type":"file","file":"NOTES/2. Windows/images/Pasted image 20240506124851.png","x":4967,"y":-1197,"width":400,"height":285}
	],
	"edges":[
		{"id":"d899a84421c29b3f","fromNode":"36a3f7e7f282ba71","fromSide":"bottom","toNode":"2b4762e8b5ef7630","toSide":"top"},
		{"id":"e31998693d6e7698","fromNode":"36a3f7e7f282ba71","fromSide":"bottom","toNode":"bc1251774e8bc568","toSide":"top"},
		{"id":"d3ce21966fec6ea6","fromNode":"2b4762e8b5ef7630","fromSide":"bottom","toNode":"f2c59834637a3c07","toSide":"top"},
		{"id":"c072946717c35545","fromNode":"36a3f7e7f282ba71","fromSide":"top","toNode":"d622ceebe111ca41","toSide":"bottom"},
		{"id":"42df0237b45e0293","fromNode":"36a3f7e7f282ba71","fromSide":"right","toNode":"17fe254da4ca9376","toSide":"top","label":"Obiects of AD"},
		{"id":"afbd38b06c02a88e","fromNode":"17fe254da4ca9376","fromSide":"right","toNode":"537d3c32bfc4306c","toSide":"left","label":"To configure users, groups or machines in Active Directory"},
		{"id":"ad85fc2de45fa4ba","fromNode":"b6475ff67cd1879c","fromSide":"right","toNode":"58d347cea7ed541c","toSide":"left"},
		{"id":"7e15c07523dd4553","fromNode":"62ea680e14602b42","fromSide":"right","toNode":"d1d0dcd6e6cdd968","toSide":"left"},
		{"id":"f4f806e0c449e170","fromNode":"b6475ff67cd1879c","fromSide":"bottom","toNode":"d1d0dcd6e6cdd968","toSide":"top"},
		{"id":"ecefeb842395a98b","fromNode":"537d3c32bfc4306c","fromSide":"left","toNode":"32f940947905d88b","toSide":"top","label":"delegation"},
		{"id":"c7147d458aa6af7e","fromNode":"289d04377b6b5891","fromSide":"right","toNode":"b6475ff67cd1879c","toSide":"left"},
		{"id":"2059277d3ac5aca9","fromNode":"ad72a852e84a2228","fromSide":"bottom","toNode":"b6475ff67cd1879c","toSide":"right","color":"4"},
		{"id":"c878f90ba1c9bb08","fromNode":"ad72a852e84a2228","fromSide":"bottom","toNode":"537d3c32bfc4306c","toSide":"top","color":"4"},
		{"id":"12d97f28ec2e4ad6","fromNode":"8e72b12003f267e7","fromSide":"left","toNode":"59883ad7483ff198","toSide":"top","color":"5"},
		{"id":"37965afc6c04d966","fromNode":"36a3f7e7f282ba71","fromSide":"right","toNode":"fea9185fb7022f08","toSide":"left","label":"Policies of AD"},
		{"id":"bd5791f10d54326e","fromNode":"c4e3f7fbbd8a29e0","fromSide":"right","toNode":"b6475ff67cd1879c","toSide":"left"},
		{"id":"3c2073f4a56199c9","fromNode":"fea9185fb7022f08","fromSide":"right","toNode":"59883ad7483ff198","toSide":"top"},
		{"id":"41ee1c8bdfbb14f1","fromNode":"59883ad7483ff198","fromSide":"right","toNode":"5658a4d0f0bac8dd","toSide":"left"},
		{"id":"259b30591324fce9","fromNode":"59883ad7483ff198","fromSide":"right","toNode":"f25c28af3b7378d9","toSide":"left"},
		{"id":"bff646014bee77cb","fromNode":"36a3f7e7f282ba71","fromSide":"right","toNode":"d33ea6d684654efc","toSide":"left","label":"Authentication Methods"},
		{"id":"26045e0024be64bb","fromNode":"bc1251774e8bc568","fromSide":"bottom","toNode":"5636a9ac9efe26aa","toSide":"top"},
		{"id":"add8930960ce1099","fromNode":"d33ea6d684654efc","fromSide":"right","toNode":"ae0f25725cf455c1","toSide":"left"},
		{"id":"005c825cd7b0ce60","fromNode":"ae0f25725cf455c1","fromSide":"right","toNode":"87e264f588b3e6a8","toSide":"left"},
		{"id":"7da796ae6c1c8923","fromNode":"d33ea6d684654efc","fromSide":"right","toNode":"17acf80b3b887a4d","toSide":"left"},
		{"id":"99f6cbccd3ee57c5","fromNode":"855e908ce3c2d467","fromSide":"bottom","toNode":"5d94481632dbe5cd","toSide":"top"},
		{"id":"8a2a5cad09191ddb","fromNode":"36a3f7e7f282ba71","fromSide":"top","toNode":"fbc958a159b20a21","toSide":"right"},
		{"id":"beb5a8e9de2519fc","fromNode":"fbc958a159b20a21","fromSide":"left","toNode":"b615830acf9346fa","toSide":"bottom"},
		{"id":"16fba65b50f3cc85","fromNode":"b615830acf9346fa","fromSide":"top","toNode":"1028fc6521e4bb7d","toSide":"left"},
		{"id":"0fa20ad440771e8a","fromNode":"36a3f7e7f282ba71","fromSide":"left","toNode":"5f0a4c818bd75a77","toSide":"top"},
		{"id":"95ce0398c72888d9","fromNode":"17acf80b3b887a4d","fromSide":"right","toNode":"2331d19d36fd4afe","toSide":"left"},
		{"id":"73fd232a4d72e656","fromNode":"59883ad7483ff198","fromSide":"bottom","toNode":"ad0bff2805a09f6f","toSide":"top"},
		{"id":"dab1e4cea94ba180","fromNode":"36a3f7e7f282ba71","fromSide":"left","toNode":"6cc953ebda25e576","toSide":"right"},
		{"id":"b657e497264b3c7a","fromNode":"d33ea6d684654efc","fromSide":"top","toNode":"1a066ee23b20fbaa","toSide":"bottom"}
	]
}